version: '3.8'

services:
  # MySQL - 日志元数据存储
  mysql:
    image: mysql:8.0.44-debian
    container_name: logx-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123      # root用户密码
      MYSQL_DATABASE: logx              # 自动创建数据库
      MYSQL_CHARSET: utf8mb4            # 字符集
      MYSQL_COLLATION: utf8mb4_unicode_ci # 排序规则
    ports:
      - "3307:3306"                     # 主机端口:容器端口 (3307避免与本地MySQL冲突)
    volumes:
      - mysql-data:/var/lib/mysql       # 数据持久化
      - ./scripts:/docker-entrypoint-initdb.d:ro  # 初始化SQL脚本目录
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck: # 健康检查
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123" ]
      timeout: 20s
      retries: 10

  # Redis - 缓存和会话存储
  redis:
    image: redis:7.2-alpine
    container_name: logx-redis
    command: redis-server --appendonly yes --requirepass redis123  # 启用AOF持久化，设置密码
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data                # 数据目录
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro  # 自定义配置
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "redis123", "ping" ]
      timeout: 10s
      retries: 5

  # Elasticsearch - 日志检索和分析
  elasticsearch:
    image: elasticsearch:7.17.15
    container_name: logx-es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.authc.api_key.enabled=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data

  # Kafka（KRaft模式）- 消息队列和日志流处理
  kafka:
    image: apache/kafka:3.7.0           # 指定版本，确保稳定性
    container_name: logx-kafka
    environment:
      # --- KRaft模式核心配置 ---
      KAFKA_NODE_ID: 1                  # 节点唯一ID
      KAFKA_PROCESS_ROLES: controller,broker  # 节点角色：控制器和代理
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093  # 仲裁投票者：节点ID@主机:端口
      CLUSTER_ID: Mk3O6tR5Rb6rA3kI0G035w  # 集群ID（任意唯一字符串）

      # --- 监听器配置 ---
      # 定义两个监听器：内部broker通信和外部客户端连接
      KAFKA_LISTENERS: CONTROLLER://:9093,INTERNAL://:9092,EXTERNAL://:29092
      # 解释：
      # CONTROLLER://:9093 - 控制器间通信（Kafka内部）
      # INTERNAL://:9092   - 容器内部服务访问
      # EXTERNAL://:29092  - 主机和外部访问

      # 安全协议映射
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT

      # 对外公布地址
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL://localhost:29092
      # 解释：
      # INTERNAL://kafka:9092     - 容器内其他服务使用服务名kafka访问
      # EXTERNAL://localhost:29092 - 主机使用localhost访问

      # 内部broker通信监听器名称
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # 控制器监听器名称
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # --- 日志和存储配置 ---
      KAFKA_LOG_DIRS: /var/lib/kafka/data

      # --- 主题和分区配置 ---
      KAFKA_NUM_PARTITIONS: 3           # 默认分区数
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1  # 默认复制因子（单节点）

      # --- 偏移量和事务配置 ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # --- 性能和调优 ---
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0      # 消费者组快速重平衡
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"       # 自动创建主题（开发环境）

    ports:
      - "9092:9092"    # 容器内部服务访问端口
      - "29092:29092"  # 主机外部访问端口
    volumes:
      - kafka-data:/var/lib/kafka/data
      - ./kafka/server.properties:/etc/kafka/server.properties:ro  # 外部配置文件
    depends_on:
      - elasticsearch  # 依赖ES，确保启动顺序
    healthcheck:
      test: [ "CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1" ]
      interval: 30s
      timeout: 20s
      retries: 5

  # MinIO - 对象存储（日志文件、备份等）
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z-cpuv1
    container_name: logx-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin            # 管理员用户名
      MINIO_ROOT_PASSWORD: admin123     # 管理员密码
      MINIO_REGION: us-east-1           # 区域
      MINIO_REGION_NAME: us-east-1      # 区域名称
    ports:
      - "9000:9000"    # S3 API端口
      - "9001:9001"    # 管理控制台端口
    volumes:
      - minio-data:/data
      - ./minio/config:/root/.minio     # 配置文件目录
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  # Kibana（可选）- Elasticsearch可视化
  kibana:
    image: kibana:7.17.15
    container_name: logx-kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_HOST=0.0.0.0
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=8rc3Jl1jlAK3uVZZyhF4
      # 设置中文语言包
      - I18N_LOCALE=zh-CN
      - i18n.locale=zh-CN
      - xpack.i18n.locale=zh-CN
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Logstash（可选）- 日志收集和处理
#  logstash:
#    image: logstash:7.17.15
#    container_name: logx-logstash
#    environment:
#      - XPACK_MONITORING_ENABLED=false
#    volumes:
#      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
#      - ./logstash/config:/usr/share/logstash/config:ro
#    ports:
#      - "5000:5000"    # TCP输入
#      - "5001:5001/tcp"
#      - "5001:5001/udp"
#    depends_on:
#      - elasticsearch
#      - kafka
#    command: logstash -f /usr/share/logstash/pipeline/

# 数据卷定义
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  es-data:
    driver: local
  kafka-data:
    driver: local
  minio-data:
    driver: local

# 网络配置（可选，提供更好的网络隔离）
networks:
  default:
    name: logx-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16